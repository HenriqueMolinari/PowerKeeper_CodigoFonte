import 'dart:io';
import 'dart:convert';
import 'package:http/http.dart' as http;
import 'Empresa.dart';
import 'Local.dart';
import 'Dispositivo.dart';
import 'SensorSCT013.dart';
import 'Leitura.dart';
import 'Usuario.dart';
import 'DatabaseConnection.dart';

class Menu {
  final DatabaseConnection dbConnection;
  bool _conectado = false;

  // üî• CONFIGURA√á√ïES FIREBASE - POWERKEEPER
  static const String _baseUrl =
      'powerkeeper-c708c-default-rtdb.firebaseio.com';

  // Listas locais
  final List<Empresa> _empresas = [];
  final List<Local> _locais = [];
  final List<Dispositivo> _dispositivos = [];
  final List<SensorSCT013> _sensores = [];
  final List<Leitura> _leituras = [];
  final List<Usuario> _usuarios = [];

  Menu(this.dbConnection);

  Future<void> inicializar() async {
    print('\nüîÑ INICIALIZANDO SISTEMA POWERKEEPER...');
    _conectado = await dbConnection.connect();

    if (_conectado) {
      print('üéâ CONEX√ÉO COM BANCO ESTABELECIDA COM SUCESSO!');
      await _carregarDadosDoBanco();
    } else {
      print('‚ùå FALHA NA CONEX√ÉO COM BANCO');
      print('‚ö†Ô∏è  Os dados ser√£o salvos apenas localmente');
    }

    print('\nüî• CONECTANDO AO FIREBASE...');
    await _carregarLeiturasFirebase();
  }

  Future<void> _carregarLeiturasFirebase() async {
    try {
      print('üì° Buscando leituras no Firebase...');
      _leituras.clear();

      // üîÑ PRIMEIRO: Buscar dados atuais
      await _carregarDadosAtuais();

      // üîÑ SEGUNDO: Buscar hist√≥rico de leituras
      await _carregarHistoricoLeituras();

      print('‚úÖ Total de leituras carregadas: ${_leituras.length}');
    } catch (e) {
      print('‚ùå Erro de conex√£o com Firebase: $e');
    }
  }

  Future<void> _carregarDadosAtuais() async {
    try {
      final url = Uri.https(_baseUrl, '/monitor/dados_atuais.json');
      final response = await http.get(url);

      if (response.statusCode == 200) {
        final dados = json.decode(response.body);

        if (dados != null) {
          final leitura = Leitura.fromFirebase(dados, 'atual');
          _leituras.add(leitura);
        }
      }
    } catch (e) {
      print('‚ùå Erro ao carregar dados atuais: $e');
    }
  }

  Future<void> _carregarHistoricoLeituras() async {
    try {
      final List<String> caminhosPossiveis = [
        '/leituras.json',
        '/monitor/leituras.json',
      ];

      int leiturasCarregadas = 0;

      for (final caminho in caminhosPossiveis) {
        try {
          final url = Uri.https(_baseUrl, caminho);
          final response = await http.get(url);

          if (response.statusCode == 200) {
            final historicoData = json.decode(response.body);

            if (historicoData != null && historicoData is Map) {
              historicoData.forEach((key, value) {
                if (value is Map) {
                  final Map<String, dynamic> valueAsStringMap = {};
                  value.forEach((k, v) {
                    valueAsStringMap[k.toString()] = v;
                  });

                  final leitura =
                      Leitura.fromFirebase(valueAsStringMap, key.toString());
                  _leituras.add(leitura);
                  leiturasCarregadas++;
                }
              });

              if (leiturasCarregadas > 0) {
                print('‚úÖ $leiturasCarregadas leituras hist√≥ricas carregadas');
                _leituras.sort((a, b) => a.timestamp.compareTo(b.timestamp));
                return;
              }
            }
          }
        } catch (e) {
          // Continua para o pr√≥ximo caminho
        }
      }

      if (leiturasCarregadas == 0) {
        print('‚ÑπÔ∏è  Nenhuma leitura hist√≥rica encontrada');
      }
    } catch (e) {
      print('‚ùå Erro ao carregar hist√≥rico de leituras: $e');
    }
  }

  Future<void> _carregarDadosDoBanco() async {
    if (!_conectado) return;

    try {
      print('\nüì• CARREGANDO DADOS DO BANCO...');

      _empresas.clear();
      _locais.clear();
      _dispositivos.clear();
      _sensores.clear();
      _usuarios.clear();

      await _carregarDadosRobusto();

      print('\n‚úÖ RESUMO DO CARREGAMENTO:');
      print('üè¢ Empresas: ${_empresas.length}');
      print('üè† Locais: ${_locais.length}');
      print('‚öôÔ∏è  Dispositivos: ${_dispositivos.length}');
      print('üì° Sensores: ${_sensores.length}');
      print('üë§ Usu√°rios: ${_usuarios.length}');
    } catch (e) {
      print('‚ùå Erro ao carregar dados do banco: $e');
    }
  }

  Future<void> _carregarDadosRobusto() async {
    try {
      // üè¢ CARREGAR EMPRESAS
      try {
        var resultados =
            await dbConnection.connection!.query('SELECT * FROM empresa');
        for (var row in resultados) {
          var dados = row.toList();
          if (dados.length >= 3 && _safeString(dados[1]).isNotEmpty) {
            _empresas.add(Empresa(_safeInt(dados[0]), _safeString(dados[1]),
                _safeString(dados[2])));
          }
        }
      } catch (e) {
        print('‚ùå Erro ao carregar empresas: $e');
      }

      // üè† CARREGAR LOCAIS
      try {
        var resultados =
            await dbConnection.connection!.query('SELECT * FROM local');
        for (var row in resultados) {
          var dados = row.toList();
          if (dados.length >= 4) {
            _locais.add(Local(_safeInt(dados[0]), _safeString(dados[1]),
                _safeString(dados[2]), _safeInt(dados[3])));
          }
        }
      } catch (e) {
        print('‚ùå Erro ao carregar locais: $e');
      }

      // ‚öôÔ∏è CARREGAR DISPOSITIVOS
      try {
        var resultados =
            await dbConnection.connection!.query('SELECT * FROM dispositivo');
        for (var row in resultados) {
          var dados = row.toList();
          if (dados.length >= 3) {
            int localId = dados.length >= 4 ? _safeInt(dados[3]) : 0;
            int sensorId = dados.length >= 5 ? _safeInt(dados[4]) : 0;
            _dispositivos.add(Dispositivo(_safeInt(dados[0]),
                _safeString(dados[1]), _safeString(dados[2]),
                localId: localId, sensorId: sensorId));
          }
        }
      } catch (e) {
        print('‚ùå Erro ao carregar dispositivos: $e');
      }

      // üì° CARREGAR SENSORES
      try {
        var resultados =
            await dbConnection.connection!.query('SELECT * FROM sensor');
        for (var row in resultados) {
          var dados = row.toList();
          if (dados.length >= 3) {
            _sensores.add(SensorSCT013(_safeInt(dados[0]),
                _safeString(dados[1]), _safeString(dados[2]), 30.0, 2.5));
          }
        }
      } catch (e) {
        print('‚ùå Erro ao carregar sensores: $e');
      }

      // üë§ CARREGAR USU√ÅRIOS
      try {
        var resultados =
            await dbConnection.connection!.query('SELECT * FROM usuario');
        for (var row in resultados) {
          var dados = row.toList();
          if (dados.length >= 3) {
            _usuarios.add(Usuario(
              idUsuario: _safeInt(dados[0]),
              nome: _safeString(dados[1]),
              email: dados.length > 2
                  ? _safeString(dados[2])
                  : 'email@exemplo.com',
              senhaLogin: dados.length > 3 ? _safeString(dados[3]) : 'senha',
              perfil: dados.length > 4 ? _safeString(dados[4]) : 'Usuario',
              dataCriacao: DateTime.now(),
              ultimoLogin: DateTime.now(),
              empresaId: dados.length > 7 ? _safeInt(dados[7]) : 1,
            ));
          }
        }
      } catch (e) {
        print('‚ùå Erro ao carregar usu√°rios: $e');
      }
    } catch (e) {
      print('‚ùå Erro geral no carregamento: $e');
    }
  }

  int _safeInt(dynamic value) {
    if (value == null) return 0;
    if (value is int) return value;
    if (value is String) return int.tryParse(value) ?? 0;
    if (value is double) return value.toInt();
    return 0;
  }

  double _safeDouble(dynamic value) {
    if (value == null) return 0.0;
    if (value is double) return value;
    if (value is int) return value.toDouble();
    if (value is String) return double.tryParse(value) ?? 0.0;
    return 0.0;
  }

  String _safeString(dynamic value) {
    if (value == null) return '';
    if (value is String) return value;
    return value.toString();
  }

  // ========== M√âTODOS DE CADASTRO ==========
  Future<void> _cadastrarEmpresa() async {
    print('\nüè¢ CADASTRAR EMPRESA');

    stdout.write('Nome: ');
    final nome = stdin.readLineSync()?.trim() ?? '';

    stdout.write('CNPJ: ');
    final cnpj = stdin.readLineSync()?.trim() ?? '';

    if (nome.isEmpty || cnpj.isEmpty) {
      print('‚ùå Nome e CNPJ s√£o obrigat√≥rios!');
      return;
    }

    final empresaExistente = _empresas.firstWhere(
      (empresa) => empresa.cnpj == cnpj,
      orElse: () => Empresa(0, '', ''),
    );

    if (empresaExistente.cnpj.isNotEmpty) {
      print('‚ùå J√° existe uma empresa com este CNPJ!');
      return;
    }

    int novoId = _empresas.isEmpty
        ? 1
        : (_empresas.map((e) => e.idEmpresa).reduce((a, b) => a > b ? a : b) +
            1);
    final empresa = Empresa(novoId, nome, cnpj);
    _empresas.add(empresa);

    if (_conectado) {
      try {
        await dbConnection.connection!.query(
          'INSERT INTO empresa (nome, cnpj) VALUES (?, ?)',
          [empresa.nome, empresa.cnpj],
        );
        print('üíæ Empresa salva no banco de dados!');
      } catch (e) {
        print('‚ùå Erro ao salvar empresa no banco: $e');
      }
    }

    print('‚úÖ Empresa cadastrada com sucesso!');
    empresa.exibirDados();
  }

  Future<void> _cadastrarLocal() async {
    print('\nüè† CADASTRAR LOCAL');

    if (_empresas.isEmpty) {
      print('‚ùå √â necess√°rio cadastrar uma empresa primeiro!');
      return;
    }

    print('\nüìã Empresas dispon√≠veis:');
    for (int i = 0; i < _empresas.length; i++) {
      print('${i + 1} - ${_empresas[i].nome} (CNPJ: ${_empresas[i].cnpj})');
    }

    int? empresaIndex;
    do {
      stdout.write('Selecione a empresa (1-${_empresas.length}): ');
      final input = stdin.readLineSync()?.trim();
      empresaIndex = int.tryParse(input ?? '');

      if (empresaIndex == null ||
          empresaIndex < 1 ||
          empresaIndex > _empresas.length) {
        print('‚ùå Selecione uma empresa v√°lida!');
      }
    } while (empresaIndex == null);

    final empresaSelecionada = _empresas[empresaIndex - 1];

    stdout.write('Nome do local: ');
    final nome = stdin.readLineSync()?.trim() ?? '';

    stdout.write('Refer√™ncia: ');
    final referencia = stdin.readLineSync()?.trim() ?? '';

    if (nome.isEmpty || referencia.isEmpty) {
      print('‚ùå Nome e refer√™ncia s√£o obrigat√≥rios!');
      return;
    }

    int novoId = _locais.isEmpty
        ? 1
        : (_locais.map((e) => e.id).reduce((a, b) => a > b ? a : b) + 1);
    final local = Local(novoId, nome, referencia, empresaSelecionada.idEmpresa);
    _locais.add(local);

    if (_conectado) {
      try {
        await dbConnection.connection!.query(
          'INSERT INTO local (nome, referencia, empresa_idEmpresa) VALUES (?, ?, ?)',
          [local.nome, local.referencia, local.empresaId],
        );
        print('üíæ Local salvo no banco de dados!');
      } catch (e) {
        print('‚ùå Erro ao salvar local no banco: $e');
      }
    }

    print('‚úÖ Local cadastrado com sucesso!');
    local.exibirDados();
  }

  Future<void> _cadastrarDispositivo() async {
    print('\n‚öôÔ∏è  CADASTRAR DISPOSITIVO');

    stdout.write('Modelo: ');
    final modelo = stdin.readLineSync()?.trim() ?? '';

    stdout.write('Status (Ativo/Inativo): ');
    final status = stdin.readLineSync()?.trim() ?? '';

    if (modelo.isEmpty || status.isEmpty) {
      print('‚ùå Modelo e status s√£o obrigat√≥rios!');
      return;
    }

    int? localId;
    if (_locais.isNotEmpty) {
      print('\nüìã Locais dispon√≠veis:');
      for (int i = 0; i < _locais.length; i++) {
        print('${i + 1} - ${_locais[i].nome}');
      }
      stdout.write('Selecione o local (0 para nenhum): ');
      final input = stdin.readLineSync()?.trim();
      final localIndex = int.tryParse(input ?? '');
      if (localIndex != null &&
          localIndex > 0 &&
          localIndex <= _locais.length) {
        localId = _locais[localIndex - 1].id;
      }
    }

    int? sensorId;
    if (_sensores.isNotEmpty) {
      print('\nüìã Sensores dispon√≠veis:');
      for (int i = 0; i < _sensores.length; i++) {
        print('${i + 1} - ${_sensores[i].tipo}');
      }
      stdout.write('Selecione o sensor (0 para nenhum): ');
      final input = stdin.readLineSync()?.trim();
      final sensorIndex = int.tryParse(input ?? '');
      if (sensorIndex != null &&
          sensorIndex > 0 &&
          sensorIndex <= _sensores.length) {
        sensorId = _sensores[sensorIndex - 1].id;
      }
    }

    int novoId = _dispositivos.isEmpty
        ? 1
        : (_dispositivos.map((e) => e.id).reduce((a, b) => a > b ? a : b) + 1);
    final dispositivo = Dispositivo(novoId, modelo, status,
        localId: localId, sensorId: sensorId);
    _dispositivos.add(dispositivo);

    if (_conectado) {
      try {
        await dbConnection.connection!.query(
          'INSERT INTO dispositivo (modelo, status, local_idLocal, sensor_idSensor) VALUES (?, ?, ?, ?)',
          [
            dispositivo.modelo,
            dispositivo.status,
            dispositivo.localId,
            dispositivo.sensorId
          ],
        );
        print('üíæ Dispositivo salvo no banco de dados!');
      } catch (e) {
        print('‚ùå Erro ao salvar dispositivo no banco: $e');
      }
    }

    print('‚úÖ Dispositivo cadastrado com sucesso!');
    dispositivo.exibirDados();
  }

  Future<void> _cadastrarSensor() async {
    print('\nüì° CADASTRAR SENSOR SCT-013');

    stdout.write('Tipo: ');
    final tipo = stdin.readLineSync()?.trim() ?? 'SCT-013';

    stdout.write('Unidade de Medida: ');
    final unidadeMedida = stdin.readLineSync()?.trim() ?? 'A';

    stdout.write('Fator de Calibra√ß√£o: ');
    final fatorCalibracao =
        double.tryParse(stdin.readLineSync()?.trim() ?? '30.0') ?? 30.0;

    stdout.write('Tens√£o de Refer√™ncia (V): ');
    final tensaoReferencia =
        double.tryParse(stdin.readLineSync()?.trim() ?? '2.5') ?? 2.5;

    if (tipo.isEmpty || unidadeMedida.isEmpty) {
      print('‚ùå Tipo e unidade de medida s√£o obrigat√≥rios!');
      return;
    }

    int novoId = _sensores.isEmpty
        ? 1
        : (_sensores.map((e) => e.id).reduce((a, b) => a > b ? a : b) + 1);
    final sensor = SensorSCT013(
        novoId, tipo, unidadeMedida, fatorCalibracao, tensaoReferencia);
    _sensores.add(sensor);

    if (_conectado) {
      try {
        await dbConnection.connection!.query(
          'INSERT INTO sensor (tipo, unidadeMedida) VALUES (?, ?)',
          [sensor.tipo, sensor.unidadeMedida],
        );
        print('üíæ Sensor salvo no banco de dados!');
      } catch (e) {
        print('‚ùå Erro ao salvar sensor no banco: $e');
      }
    }

    print('‚úÖ Sensor cadastrado com sucesso!');
    sensor.exibirDados();
  }

  Future<void> _cadastrarUsuario() async {
    print('\nüë§ CADASTRAR USU√ÅRIO');

    if (_empresas.isEmpty) {
      print('‚ùå √â necess√°rio cadastrar uma empresa primeiro!');
      return;
    }

    stdout.write('Nome: ');
    final nome = stdin.readLineSync()?.trim() ?? '';

    stdout.write('Email: ');
    final email = stdin.readLineSync()?.trim() ?? '';

    stdout.write('Senha: ');
    final senha = stdin.readLineSync()?.trim() ?? '';

    stdout.write('Perfil (Administrador/Operador/Visualizador): ');
    final perfil = stdin.readLineSync()?.trim() ?? '';

    if (nome.isEmpty || email.isEmpty || senha.isEmpty || perfil.isEmpty) {
      print('‚ùå Todos os campos s√£o obrigat√≥rios!');
      return;
    }

    print('\nüìã Empresas dispon√≠veis:');
    for (int i = 0; i < _empresas.length; i++) {
      print('${i + 1} - ${_empresas[i].nome}');
    }

    int? empresaIndex;
    do {
      stdout.write('Selecione a empresa (1-${_empresas.length}): ');
      final input = stdin.readLineSync()?.trim();
      empresaIndex = int.tryParse(input ?? '');

      if (empresaIndex == null ||
          empresaIndex < 1 ||
          empresaIndex > _empresas.length) {
        print('‚ùå Selecione uma empresa v√°lida!');
      }
    } while (empresaIndex == null);

    final empresaSelecionada = _empresas[empresaIndex - 1];

    int novoId = _usuarios.isEmpty
        ? 1
        : (_usuarios.map((e) => e.idUsuario).reduce((a, b) => a > b ? a : b) +
            1);
    final usuario = Usuario(
      idUsuario: novoId,
      nome: nome,
      email: email,
      senhaLogin: senha,
      perfil: perfil,
      dataCriacao: DateTime.now(),
      ultimoLogin: DateTime.now(),
      empresaId: empresaSelecionada.idEmpresa,
    );

    _usuarios.add(usuario);

    if (_conectado) {
      try {
        await dbConnection.connection!.query(
          'INSERT INTO usuario (nome, email, senhaLogin, perfil, dataCriacao, ultimoLogin, empresa_idEmpresa) VALUES (?, ?, ?, ?, ?, ?, ?)',
          [
            usuario.nome,
            usuario.email,
            usuario.senhaLogin,
            usuario.perfil,
            usuario.dataCriacao.toIso8601String(),
            usuario.ultimoLogin.toIso8601String(),
            usuario.empresaId
          ],
        );
        print('üíæ Usu√°rio salvo no banco de dados!');
      } catch (e) {
        print('‚ùå Erro ao salvar usu√°rio no banco: $e');
      }
    }

    print('‚úÖ Usu√°rio cadastrado com sucesso!');
    usuario.exibirDados();
  }

  // ========== M√âTODOS DE CONSULTA ==========
  void _listarTodasEntidades() {
    print('\nüìã RESUMO GERAL DO SISTEMA POWERKEEPER');
    print('‚ïê' * 50);
    print('üè¢ EMPRESAS: ${_empresas.length}');
    for (var empresa in _empresas) {
      print('   ‚Ä¢ ${empresa.nome} (CNPJ: ${empresa.cnpj})');
    }

    print('\nüè† LOCAIS: ${_locais.length}');
    for (var local in _locais) {
      print('   ‚Ä¢ ${local.nome} (Ref: ${local.referencia})');
    }

    print('\n‚öôÔ∏è  DISPOSITIVOS: ${_dispositivos.length}');
    for (var dispositivo in _dispositivos) {
      print('   ‚Ä¢ ${dispositivo.modelo} (Status: ${dispositivo.status})');
    }

    print('\nüì° SENSORES: ${_sensores.length}');
    for (var sensor in _sensores) {
      print('   ‚Ä¢ ${sensor.tipo} (Unidade: ${sensor.unidadeMedida})');
    }

    print('\nüë§ USU√ÅRIOS: ${_usuarios.length}');
    for (var usuario in _usuarios) {
      print('   ‚Ä¢ ${usuario.nome} (Perfil: ${usuario.perfil})');
    }

    print('\nüìä LEITURAS ENERG√âTICAS: ${_leituras.length}');
    if (_leituras.isNotEmpty) {
      final ultimaLeitura = _leituras.last;
      print(
          '   ‚Ä¢ √öltima: ${ultimaLeitura.potencia.toStringAsFixed(1)}W - ${ultimaLeitura.corrente.toStringAsFixed(3)}A - ${ultimaLeitura.consumoKwh.toStringAsFixed(6)}kWh');
    }
    print('‚ïê' * 50);
  }

  void _listarEmpresas() {
    print('\nüè¢ LISTA DE EMPRESAS');
    print('‚ïê' * 50);
    if (_empresas.isEmpty) {
      print('üì≠ Nenhuma empresa cadastrada');
    } else {
      for (var empresa in _empresas) {
        empresa.exibirDados();
      }
    }
  }

  void _listarLocais() {
    print('\nüè† LISTA DE LOCAIS');
    print('‚ïê' * 50);
    if (_locais.isEmpty) {
      print('üì≠ Nenhum local cadastrada');
    } else {
      for (var local in _locais) {
        local.exibirDados();
      }
    }
  }

  void _listarDispositivos() {
    print('\n‚öôÔ∏è  LISTA DE DISPOSITIVOS');
    print('‚ïê' * 50);
    if (_dispositivos.isEmpty) {
      print('üì≠ Nenhum dispositivo cadastrado');
    } else {
      for (var dispositivo in _dispositivos) {
        dispositivo.exibirDados();
      }
    }
  }

  void _listarSensores() {
    print('\nüì° LISTA DE SENSORES');
    print('‚ïê' * 50);
    if (_sensores.isEmpty) {
      print('üì≠ Nenhum sensor cadastrado');
    } else {
      for (var sensor in _sensores) {
        sensor.exibirDados();
      }
    }
  }

  void _listarUsuarios() {
    print('\nüë§ LISTA DE USU√ÅRIOS');
    print('‚ïê' * 50);
    if (_usuarios.isEmpty) {
      print('üì≠ Nenhum usu√°rio cadastrado');
    } else {
      for (var usuario in _usuarios) {
        usuario.exibirDados();
      }
    }
  }

  void _listarLeituras() {
    print('\nüìä LISTA DE LEITURAS ENERG√âTICAS');
    print('‚ïê' * 50);
    if (_leituras.isEmpty) {
      print('üì≠ Nenhuma leitura registrada');
    } else {
      for (var leitura in _leituras) {
        print(leitura.toString());
      }
    }
  }

  // ========== M√âTODOS ESPEC√çFICOS DO POWERKEEPER ==========
  void _calcularEconomia() {
    print('\nüí∞ CALCULAR ECONOMIA DE ENERGIA');
    print('‚ïê' * 50);

    if (_leituras.isEmpty) {
      print('‚ùå Nenhuma leitura dispon√≠vel');
      return;
    }

    double consumoTotal =
        _leituras.map((l) => l.consumoKwh).reduce((a, b) => a + b);
    double custoTotal = _leituras.map((l) => l.custo).reduce((a, b) => a + b);
    double potenciaMedia =
        _leituras.map((l) => l.potencia).reduce((a, b) => a + b) /
            _leituras.length;

    print('üìä AN√ÅLISE DE CONSUMO');
    print('‚îÄ' * 40);
    print('üí° Consumo total: ${consumoTotal.toStringAsFixed(2)} kWh');
    print('üí∞ Custo total: R\$ ${custoTotal.toStringAsFixed(2)}');
    print('‚ö° Pot√™ncia m√©dia: ${potenciaMedia.toStringAsFixed(1)} W');
    print('üìà N√∫mero de medi√ß√µes: ${_leituras.length}');
    print('‚îÄ' * 40);

    if (potenciaMedia > 1000) {
      print('üí° SUGEST√ÉO: Considere otimizar equipamentos de alto consumo');
    }
    if (consumoTotal > 100) {
      print(
          'üí° SUGEST√ÉO: Avalie a possibilidade de migra√ß√£o para tarifa branca');
    }
  }

  Future<void> _enviarLeiturasParaMySQL() async {
    print('\nüì§ ENVIAR LEITURAS DO FIREBASE PARA MYSQL');
    print('‚ïê' * 50);

    if (_leituras.isEmpty) {
      print('‚ùå Nenhuma leitura dispon√≠vel para enviar');
      return;
    }

    if (!_conectado) {
      print('‚ùå Sem conex√£o com o banco MySQL');
      return;
    }

    if (_sensores.isEmpty) {
      print('‚ùå Nenhum sensor cadastrado no MySQL');
      return;
    }

    final sensorId = _sensores.first.id;
    int leiturasEnviadas = 0;

    print('üìä Total de leituras no Firebase: ${_leituras.length}');
    print('üöÄ Enviando leituras...');

    for (final leitura in _leituras) {
      try {
        String dataFormatada = _formatarDataParaMySQL(leitura.timestamp);

        await dbConnection.connection!.query(
          '''INSERT INTO leitura 
           (timeStamp, tensao, corrente, potencia, consumokWh, custo, sensor_idSensor) 
           VALUES (?, ?, ?, ?, ?, ?, ?)''',
          [
            dataFormatada,
            leitura.tensao,
            leitura.corrente,
            leitura.potencia,
            leitura.consumoKwh,
            leitura.custo,
            sensorId,
          ],
        );

        leiturasEnviadas++;
      } catch (e) {
        print('‚ùå Erro ao enviar leitura ${leitura.id}: $e');
      }
    }

    print('‚úÖ $leiturasEnviadas leitura(s) enviada(s) para MySQL!');
  }

  String _formatarDataParaMySQL(DateTime dateTime) {
    String year = dateTime.year.toString();
    String month = dateTime.month.toString().padLeft(2, '0');
    String day = dateTime.day.toString().padLeft(2, '0');
    String hour = dateTime.hour.toString().padLeft(2, '0');
    String minute = dateTime.minute.toString().padLeft(2, '0');
    String second = dateTime.second.toString().padLeft(2, '0');

    return '$year-$month-$day $hour:$minute:$second';
  }

  // ========== M√âTODO PRINCIPAL ==========
  Future<void> executar() async {
    print("\n");
    print('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    print('‚ïë           SISTEMA DE MONITORAMENTO           ‚ïë');
    print('‚ïë              ‚ö° POWERKEEPER ‚ö°                ‚ïë');
    print('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

    if (_conectado) {
      print('‚úÖ CONECTADO AO BANCO DE DADOS');
    } else {
      print('‚ùå SEM CONEX√ÉO COM BANCO - Dados apenas locais');
    }

    print('üî• CONECTADO AO FIREBASE');
    print('üìä Leituras carregadas: ${_leituras.length}');

    bool executando = true;

    while (executando) {
      print('\n' + '‚ïê' * 60);
      print('üîß MENU PRINCIPAL - POWERKEEPER');
      print('‚ïê' * 60);
      print('üìã CADASTROS:');
      print(' 1  - üè¢ Cadastrar Empresa');
      print(' 2  - üè† Cadastrar Local');
      print(' 3  - ‚öôÔ∏è  Cadastrar Dispositivo');
      print(' 4  - üì° Cadastrar Sensor SCT-013');
      print(' 5  - üë§ Cadastrar Usu√°rio');
      print('‚ïê' * 60);
      print('üîç CONSULTAS:');
      print(' 6  - üìä Listar Todas as Entidades');
      print(' 7  - üè¢ Listar Empresas');
      print(' 8  - üè† Listar Locais');
      print(' 9  - ‚öôÔ∏è  Listar Dispositivos');
      print('10  - üì° Listar Sensores');
      print('11  - üë§ Listar Usu√°rios');
      print('‚ïê' * 60);
      print('‚ö° ENERGIA & MEDI√á√ïES:');
      print('12 - üìä Listar Todas as Leituras');
      print('13 - üí∞ Calcular Economia');
      print('14 - üì§ Enviar Leituras para MySQL');
      print('15 - üîÑ Recarregar Dados do Firebase');
      print('‚ïê' * 60);

      stdout.write('üëâ Escolha: ');
      final opcao = stdin.readLineSync();

      switch (opcao) {
        case '1':
          await _cadastrarEmpresa();
          break;
        case '2':
          await _cadastrarLocal();
          break;
        case '3':
          await _cadastrarDispositivo();
          break;
        case '4':
          await _cadastrarSensor();
          break;
        case '5':
          await _cadastrarUsuario();
          break;
        case '6':
          _listarTodasEntidades();
          break;
        case '7':
          _listarEmpresas();
          break;
        case '8':
          _listarLocais();
          break;
        case '9':
          _listarDispositivos();
          break;
        case '10':
          _listarSensores();
          break;
        case '11':
          _listarUsuarios();
          break;
        case '12':
          _listarLeituras();
          break;
        case '13':
          _calcularEconomia();
          break;
        case '14':
          await _enviarLeiturasParaMySQL();
          break;
        case '15':
          print('\nüîÑ RECARREGANDO DADOS DO FIREBASE...');
          await _carregarLeiturasFirebase();
          break;
        case '0':
          await dbConnection.close();
          print('\nüëã Encerrando PowerKeeper...');
          executando = false;
          break;
        default:
          print('‚ùå Op√ß√£o inv√°lida!');
      }

      if (executando) {
        print('\n‚èé Pressione Enter para continuar...');
        stdin.readLineSync();
      }
    }

    print('\n‚ö° PowerKeeper finalizado. At√© logo!');
  }
}
